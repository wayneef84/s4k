<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>S4K Mixer V2</title>
    
    <!--
    ╔══════════════════════════════════════════════════════════════════╗
    ║  S4K MIXER - VERSION HISTORY                                     ║
    ╠══════════════════════════════════════════════════════════════════╣
    ║                                                                  ║
    ║  v1.0 - Initial MVP                                              ║
    ║    • Basic mixer functionality with Web Audio API                ║
    ║    • Hardcoded character data with MD5 hash filenames            ║
    ║    • Single flat asset folder (Sprunki/)                         ║
    ║    • Desktop-focused layout                                      ║
    ║                                                                  ║
    ║  v2.0 - Config-Driven Refactor (Current)                         ║
    ║    • External config.json for character definitions              ║
    ║    • Organized asset structure: assets/audio/, assets/img/       ║
    ║    • Human-readable filenames (b01.wav instead of MD5 hashes)    ║
    ║    • Character names displayed in palette labels                 ║
    ║    • Mobile-first responsive design (Fire Tablet optimized)      ║
    ║    • Touch-friendly controls with visual feedback                ║
    ║    • Play/Pause button (green) + Reset button (red pill)         ║
    ║    • Category color-coding (yellow/purple/red/blue)              ║
    ║    • Landscape and portrait orientation support                  ║
    ║    • Easy character addition via config.json only                ║
    ║                                                                  ║
    ║  Adding New Characters:                                          ║
    ║    1. Drop audio file in assets/audio/ (e.g., b06.wav)           ║
    ║    2. Drop image file in assets/img/ (e.g., b06.svg)             ║
    ║    3. Add entry to config.json characters array:                 ║
    ║       { "id": "b06", "name": "Aqua", "type": "beats",            ║
    ║         "audio": "b06.wav", "img": "b06.svg" }                   ║
    ║    4. Refresh browser - no code changes needed!                  ║
    ║                                                                  ║
    ╚══════════════════════════════════════════════════════════════════╝
    -->
    
    <style>
        /* ============================================================
           S4K V2 STYLES - Mobile First
           ============================================================ */
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: #0f0f1b; 
            color: white; 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            text-align: center; 
            margin: 0; 
            padding: 10px; 
            padding-bottom: 120px;
            min-height: 100vh;
        }
        
        h1 { 
            font-size: 1.4rem; 
            margin: 8px 0 12px; 
            letter-spacing: 2px;
        }
        
        /* ------------------------------------------------------------
           Controls - Play + Reset Buttons
           ------------------------------------------------------------ */
        .controls { 
            display: flex; 
            justify-content: center; 
            align-items: center;
            gap: 15px; 
            margin-bottom: 15px;
            padding: 0 10px;
        }
        
        /* Play/Pause - Green Circle */
        .btn-play { 
            width: 70px; 
            height: 70px; 
            border-radius: 50%; 
            border: none; 
            font-size: 2rem; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #2ecc71; 
            color: white;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);
            transition: transform 0.1s, background 0.2s;
        }
        .btn-play:active { transform: scale(0.92); }
        .btn-play.playing { 
            background: #f39c12; 
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
        }
        
        /* Reset - Red Pill with Icon + Text */
        .btn-reset { 
            height: 50px;
            padding: 0 20px;
            border-radius: 25px; 
            border: none; 
            font-size: 1rem; 
            font-weight: 600;
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            gap: 8px;
            background: #e74c3c; 
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
            transition: transform 0.1s;
        }
        .btn-reset:active { transform: scale(0.95); }
        .btn-reset .icon { font-size: 1.2rem; }
        
        /* ------------------------------------------------------------
           Stage - Where active characters appear
           ------------------------------------------------------------ */
        .stage { 
            display: flex; 
            justify-content: center; 
            align-items: center;
            gap: 8px; 
            padding: 12px 10px; 
            background: rgba(255,255,255,0.03); 
            border-radius: 16px; 
            min-height: 95px; 
            margin: 0 auto 15px;
            border: 1px solid #333;
            flex-wrap: wrap;
            max-width: 550px;
        }
        
        .slot { 
            width: 65px; 
            height: 80px; 
            border: 2px dashed #444; 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: 0.2s;
            font-size: 1.5rem; 
            color: #555;
            background: rgba(0,0,0,0.2);
        }
        .slot.active { 
            border-style: solid; 
            border-color: #00f3ff; 
            background: rgba(0, 243, 255, 0.08); 
            box-shadow: 0 0 12px rgba(0, 243, 255, 0.5);
            animation: pulse 2s infinite;
        }
        .slot img { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            border-radius: 8px;
        }
        
        @keyframes pulse { 
            0%, 100% { box-shadow: 0 0 8px rgba(0, 243, 255, 0.5); } 
            50% { box-shadow: 0 0 16px rgba(0, 243, 255, 0.7); } 
        }
        
        /* ------------------------------------------------------------
           Palette - Character selection grid
           ------------------------------------------------------------ */
        .palette { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 8px; 
            max-width: 450px; 
            margin: 0 auto; 
            padding: 5px 10px;
        }
        
        .cat-header { 
            grid-column: 1 / -1; 
            text-align: left; 
            font-size: 11px; 
            color: #666; 
            text-transform: uppercase; 
            margin-top: 8px; 
            padding: 4px 0;
            border-bottom: 1px solid #333;
            letter-spacing: 1px;
        }
        
        .char-box { 
            aspect-ratio: 1;
            background: rgba(255,255,255,0.06); 
            padding: 6px; 
            border-radius: 10px; 
            cursor: pointer; 
            transition: 0.15s; 
            border: 2px solid transparent;
            border-bottom-width: 3px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .char-box:active { 
            transform: scale(0.93); 
            background: rgba(255,255,255,0.12); 
        }
        .char-box img { 
            width: 80%; 
            height: 60%; 
            object-fit: contain; 
            pointer-events: none; 
        }
        .char-label { 
            font-size: 8px; 
            color: #aaa; 
            margin-top: 2px; 
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        
        /* ------------------------------------------------------------
           Loading & Error States
           ------------------------------------------------------------ */
        .loading { 
            grid-column: 1 / -1;
            padding: 30px; 
            color: #555; 
        }
        .error { 
            grid-column: 1 / -1;
            padding: 15px; 
            color: #e74c3c; 
            background: rgba(231,76,60,0.1); 
            border-radius: 10px; 
        }
        
        /* ------------------------------------------------------------
           Responsive Breakpoints
           ------------------------------------------------------------ */
        
        /* Small phones */
        @media (max-width: 400px) {
            .palette { grid-template-columns: repeat(4, 1fr); }
            .slot { width: 55px; height: 70px; }
            .btn-play { width: 60px; height: 60px; font-size: 1.6rem; }
            .btn-reset { height: 44px; padding: 0 16px; font-size: 0.9rem; }
        }
        
        /* Landscape mode */
        @media (orientation: landscape) and (max-height: 500px) {
            h1 { font-size: 1.1rem; margin: 5px 0 8px; }
            .controls { gap: 12px; margin-bottom: 10px; }
            .btn-play { width: 55px; height: 55px; font-size: 1.4rem; }
            .btn-reset { height: 40px; padding: 0 14px; font-size: 0.85rem; }
            .stage { min-height: 75px; padding: 8px; gap: 6px; }
            .slot { width: 50px; height: 65px; }
            .palette { gap: 6px; max-width: 400px; }
            .char-box { padding: 4px; }
            .char-label { font-size: 7px; }
        }
        
        /* Tablet */
        @media (min-width: 700px) {
            .palette { 
                grid-template-columns: repeat(5, 1fr); 
                max-width: 500px;
                gap: 10px;
            }
            .stage { max-width: 600px; }
            .slot { width: 70px; height: 85px; }
            .char-label { font-size: 9px; }
        }
    </style>
</head>
<body>
    <h1>S4K MIXER</h1>
    
    <div class="controls">
        <button id="playBtn" class="btn-play" aria-label="Play">▶</button>
        <button id="resetBtn" class="btn-reset" aria-label="Reset">
            <span class="icon">↺</span>
            <span>Reset</span>
        </button>
    </div>
    
    <div class="stage" id="stage">
        <div class="loading">Loading...</div>
    </div>
    
    <div id="palette" class="palette">
        <div class="loading">Loading...</div>
    </div>

    <script>
        /*
         * S4K MIXER V2 - Main Application Script
         * 
         * Features:
         * - Config-driven character loading from config.json
         * - Web Audio API with gapless looping
         * - AudioContext resume on user interaction (browser requirement)
         * - Dynamic UI generation from config
         * 
         * Dependencies: None (vanilla JS)
         */
        
        let config = null;
        let audioCtx = null;
        const activeSources = {};
        let isPlaying = false;
        const SLOT_COUNT = 7;
        
        /**
         * Initialize the application
         * Loads config.json and builds the UI
         */
        async function init() {
            try {
                const response = await fetch('./config.json');
                if (!response.ok) throw new Error('Config not found');
                config = await response.json();
                
                buildStage();
                buildPalette();
                setupControls();
                
                console.log(`S4K V2: ${config.characters.length} characters loaded`);
            } catch (err) {
                console.error('Init error:', err);
                document.getElementById('stage').innerHTML = 
                    `<div class="error">Error: ${err.message}<br><small>Run with local server</small></div>`;
                document.getElementById('palette').innerHTML = '';
            }
        }
        
        /**
         * Build the stage with empty slots
         */
        function buildStage() {
            const stage = document.getElementById('stage');
            stage.innerHTML = '';
            for (let i = 0; i < SLOT_COUNT; i++) {
                const slot = document.createElement('div');
                slot.className = 'slot';
                slot.id = `slot-${i}`;
                slot.textContent = '+';
                slot.onclick = () => removeFromSlot(i);
                stage.appendChild(slot);
            }
        }
        
        /**
         * Build the character palette from config
         * Groups characters by category and displays with names
         */
        function buildPalette() {
            const palette = document.getElementById('palette');
            palette.innerHTML = '';
            
            // Group characters by type
            const byType = {};
            config.characters.forEach(char => {
                if (!byType[char.type]) byType[char.type] = [];
                byType[char.type].push(char);
            });
            
            // Render each category
            config.categories.forEach(cat => {
                if (!byType[cat.id]) return;
                
                // Category header
                const header = document.createElement('div');
                header.className = 'cat-header';
                header.textContent = cat.label;
                header.style.borderBottomColor = cat.color;
                palette.appendChild(header);
                
                // Character boxes - now showing name instead of id
                byType[cat.id].forEach(char => {
                    const box = document.createElement('div');
                    box.className = 'char-box';
                    box.style.borderBottomColor = cat.color;
                    box.innerHTML = `
                        <img src="${config.paths.img}${char.img}" alt="${char.name}" 
                             onerror="this.style.opacity='0.3'">
                        <span class="char-label">${char.name}</span>
                    `;
                    box.onclick = () => addToStage(char);
                    palette.appendChild(box);
                });
            });
        }
        
        /**
         * Setup control button event handlers
         */
        function setupControls() {
            document.getElementById('playBtn').onclick = togglePlay;
            document.getElementById('resetBtn').onclick = clearStage;
        }
        
        /**
         * Get or create AudioContext
         * Handles browser autoplay restrictions
         */
        function getAudioContext() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            return audioCtx;
        }
        
        /**
         * Toggle play/pause state for all active sounds
         */
        function togglePlay() {
            const ctx = getAudioContext();
            isPlaying = !isPlaying;
            
            const btn = document.getElementById('playBtn');
            if (isPlaying) {
                btn.textContent = '⏸';
                btn.classList.add('playing');
                ctx.resume();
            } else {
                btn.textContent = '▶';
                btn.classList.remove('playing');
                ctx.suspend();
            }
        }
        
        /**
         * Add a character to the stage
         * @param {Object} char - Character object from config
         */
        async function addToStage(char) {
            const ctx = getAudioContext();
            
            // Find first empty slot
            const slots = document.querySelectorAll('.slot');
            let emptySlot = null;
            for (const slot of slots) {
                if (slot.textContent === '+') {
                    emptySlot = slot;
                    break;
                }
            }
            if (!emptySlot) return; // Stage full
            
            // Update visual
            emptySlot.innerHTML = `<img src="${config.paths.img}${char.img}" alt="${char.name}">`;
            emptySlot.classList.add('active');
            emptySlot.dataset.charId = char.id;
            
            // Load and play audio
            try {
                const response = await fetch(`${config.paths.audio}${char.audio}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await ctx.decodeAudioData(arrayBuffer);
                
                const source = ctx.createBufferSource();
                source.buffer = audioBuffer;
                source.loop = true;
                source.connect(ctx.destination);
                source.start(0);
                
                activeSources[emptySlot.id] = source;
                
                // Sync with current play state
                if (!isPlaying) ctx.suspend();
                
            } catch (err) {
                console.error(`Load failed: ${char.audio}`, err);
                emptySlot.innerHTML = '❌';
                emptySlot.classList.remove('active');
            }
        }
        
        /**
         * Remove a character from a slot
         * @param {number} index - Slot index (0-6)
         */
        function removeFromSlot(index) {
            const slotId = `slot-${index}`;
            const slot = document.getElementById(slotId);
            
            // Stop audio if playing
            if (activeSources[slotId]) {
                activeSources[slotId].stop();
                delete activeSources[slotId];
            }
            
            // Reset visual
            slot.innerHTML = '+';
            slot.classList.remove('active');
            delete slot.dataset.charId;
        }
        
        /**
         * Clear all characters from stage
         */
        function clearStage() {
            for (let i = 0; i < SLOT_COUNT; i++) {
                removeFromSlot(i);
            }
            isPlaying = false;
            const btn = document.getElementById('playBtn');
            btn.textContent = '▶';
            btn.classList.remove('playing');
            if (audioCtx) audioCtx.resume();
        }
        
        // Start the app
        init();
    </script>
</body>
</html>